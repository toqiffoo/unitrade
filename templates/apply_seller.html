<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UniTrade | Seller Verification</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4>üëÆ‚Äç‚ôÇÔ∏è Seller Verification Required</h4>
                </div>
                <div class="card-body">
                    <p class="text-muted">To prevent fraud, you must verify your identity before selling items or offering services. This data is visible <strong>only to Admins</strong>.</p>
                    
                    <form id="verify-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Full Name (as per NRIC/Passport)</label>
                                <input type="text" class="form-control" id="real-name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">IC / Passport Number</label>
                                <input type="text" class="form-control" id="nric" placeholder="e.g. 020101-10-1234" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Matric / Staff ID Number</label>
                                <input type="text" class="form-control" id="matric" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">University Email</label>
                                <input type="email" class="form-control" value="{{ session.user_email }}" disabled>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Upload Student/Staff ID Card (Image)</label>
                            <input type="file" class="form-control" id="id-card-img" accept="image/*" required>
                        </div>

                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" required>
                            <label class="form-check-label text-small">
                                I agree that my details will be stored for security purposes. I understand that fraud will result in disciplinary action by the University.
                            </label>
                        </div>

                        <button type="submit" class="btn btn-success w-100" id="submit-btn">Submit Application</button>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-link w-100 mt-2">Back to Dashboard</a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDtTsByQ3oaYkSTJw9s9BVpdLoJ5yQ5rDE",
        authDomain: "unitrade-839f0.firebaseapp.com",
        projectId: "unitrade-839f0",
        storageBucket: "unitrade-839f0.firebasestorage.app",
        messagingSenderId: "684492149556",
        appId: "1:684492149556:web:8049eedd828f4b99b60b61",
        measurementId: "G-FESZB67P9B"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();

    document.getElementById('verify-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submit-btn');
        btn.disabled = true;
        btn.textContent = "Uploading...";

        const file = document.getElementById('id-card-img').files[0];
        
        try {
            // Upload ID Card
            const ref = storage.ref(`verification/${Date.now()}_${file.name}`);
            await ref.put(file);
            const url = await ref.getDownloadURL();

            // Send to Backend
            const response = await fetch('/api/submit_verification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    real_name: document.getElementById('real-name').value,
                    nric: document.getElementById('nric').value,
                    matric: document.getElementById('matric').value,
                    id_card_url: url
                })
            });

            const data = await response.json();
            alert(data.message);
            window.location.href = "{{ url_for('dashboard') }}";

        } catch (error) {
            console.error(error);
            alert("Error submitting application.");
            btn.disabled = false;
        }
    });
</script>
</body>
</html>